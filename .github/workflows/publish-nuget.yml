# .github/workflows/publish-nuget.yml
# Publish NuGet Package on Tag
name: Publish NuGet Package

on:
  workflow_dispatch:
    inputs:
      package_name:
        description: 'The name of the package to publish (e.g., RA.Utilities.Api)'
        required: true
        type: string

permissions:
  # This permission is required for the softprops/action-gh-release action to create a GitHub release.
  contents: write
  # This permission is required to publish to GitHub Packages.
  packages: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          # Use .NET 8.0 which is stable, or if you need 10.0, use a specific version
          dotnet-version: 10.0.*

      - name: Set Environment Variables from Project File
        run: |
          PACKAGE_NAME="${{ inputs.package_name }}"
          echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV

          PROJECT_FILE_PATH=$(find . -type f -name "${PACKAGE_NAME}.csproj" | head -n 1)
          echo "PROJECT_FILE_PATH=${PROJECT_FILE_PATH}" >> $GITHUB_ENV

          # Use msbuild to reliably get the final PackageVersion property
          # This correctly evaluates Directory.Build.props
          # The command runs a specific target that prints the version and then stops the build.
          PACKAGE_VERSION=$(dotnet build "${PROJECT_FILE_PATH}" -t:GetPackageVersion -p:Configuration=Release -v:q -noconsolelogger "/p:CustomAfterMicrosoftCommonTargets=$(pwd)/GetProperty.targets" | tr -d '\r\n')
          echo "PACKAGE_VERSION=${PACKAGE_VERSION}" >> $GITHUB_ENV

          # Determine if it's a pre-release
          IS_PRERELEASE=$(echo "$PACKAGE_VERSION" | grep -q "-" && echo "true" || echo "false")
          echo "IS_PRERELEASE=${IS_PRERELEASE}" >> $GITHUB_ENV

      - name: Validate Package Version
        run: |
          if [ -z "${{ env.PACKAGE_VERSION }}" ]; then
            echo "::error::Failed to extract PACKAGE_VERSION from project file."
            exit 1
          fi
          echo "Package version is: ${{ env.PACKAGE_VERSION }}"

      - name: Show project info
        run: |
          echo "Project file: ${{ env.PROJECT_FILE_PATH }}"
          echo "Target framework from project:"
          grep -oP '<TargetFramework>[^<]+' "${{ env.PROJECT_FILE_PATH }}" || echo "No TargetFramework found"

      - name: Restore dependencies
        run: dotnet restore "${{ env.PROJECT_FILE_PATH }}"

      - name: Build project
        run: dotnet build "${{ env.PROJECT_FILE_PATH }}" --configuration Release --no-restore

      - name: Pack Package
        run: |
          # Pack the project, but do not build again
          dotnet pack "${{ env.PROJECT_FILE_PATH }}" \
            --configuration Release \
            --no-build \
            --no-restore \
            --output ./nuget-packages \
            -p:Version="${{ env.PACKAGE_VERSION }}" # Override is kept to ensure the extracted version is used

      - name: List generated packages
        run: ls -la ./nuget-packages/

      - name: Publish to NuGet.org
        run: |
          # dotnet nuget push "./nuget-packages/${{ env.PACKAGE_NAME }}.${{ env.PACKAGE_VERSION }}.nupkg" \
          # Push both the main package and the symbols package
          dotnet nuget push "./nuget-packages/*.nupkg" \
            --api-key ${{ secrets.RA_UTILITIES_NUGET_KEY }} \
            --source "https://api.nuget.org/v3/index.json" \
            --skip-duplicate

      - name: Publish to GitHub Packages
        run: |
          dotnet nuget push "./nuget-packages/*.nupkg" \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
            --skip-duplicate

      - name: Create Git Tag
        run: |
          TAG_NAME="${{ env.PACKAGE_NAME }}/${{ env.PACKAGE_VERSION }}"
          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_ENV
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${TAG_NAME}" -m "Release ${{ env.PACKAGE_NAME }} ${{ env.PACKAGE_VERSION }}"
          git push origin "${TAG_NAME}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ env.PACKAGE_NAME }} v${{ env.PACKAGE_VERSION }}
          body: |
            ## Version ${{ env.PACKAGE_VERSION }}

            This is a pre-release of the **${{ env.PACKAGE_NAME }}** package.
            
            - **View on NuGet.org:** [${{ env.PACKAGE_NAME }} ${{ env.PACKAGE_VERSION }}](https://www.nuget.org/packages/${{ env.PACKAGE_NAME }}/${{ env.PACKAGE_VERSION }})
          files: ./nuget-packages/*
          prerelease: ${{ env.IS_PRERELEASE }}
          tag_name: ${{ env.TAG_NAME }}