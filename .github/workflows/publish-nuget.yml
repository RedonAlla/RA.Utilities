# .github/workflows/publish-nuget.yml
# Publish NuGet Package on Tag
name: Publish NuGet

on:
  push:
    tags:
      - '*-v*.*.*'

permissions:
  # This permission is required for the softprops/action-gh-release action to create a GitHub release.
  contents: write
  # This permission is required to publish to GitHub Packages.
  packages: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          # Use .NET 8.0 which is stable, or if you need 10.0, use a specific version
          dotnet-version: 10.0.*

      - name: Parse Tag and Set Environment Variables
        run: |
          TAG_NAME="${{ github.ref_name }}"

          PACKAGE_NAME="${TAG_NAME%-v*}"
          echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV

          PACKAGE_VERSION="${TAG_NAME##*-v}"
          echo "PACKAGE_VERSION=${PACKAGE_VERSION}" >> $GITHUB_ENV

          PROJECT_FILE_PATH=$(find . -type f -name "${PACKAGE_NAME}.csproj" | head -n 1)
          echo "PROJECT_FILE_PATH=${PROJECT_FILE_PATH}" >> $GITHUB_ENV

      - name: Update .csproj Version
        run: |
          echo "Updating ${{ env.PROJECT_FILE_PATH }} to version ${{ env.PACKAGE_VERSION }}"
          sed -i "s|<Version>.*</Version>|<Version>${{ env.PACKAGE_VERSION }}</Version>|" "${{ env.PROJECT_FILE_PATH }}"

      - name: Commit and Push Version Change
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add "${{ env.PROJECT_FILE_PATH }}"
          # The commit message includes [skip ci] to prevent workflow recursion
          git commit -m "ci: Bump version of ${{ env.PACKAGE_NAME }} to ${{ env.PACKAGE_VERSION }} [skip ci]"
          # Push to the branch the tag is on, not the tag itself
          git push origin HEAD:${{ github.ref_name }}

      - name: Show project info
        run: |
          echo "Project file: ${{ env.PROJECT_FILE_PATH }}"
          echo "Target framework from project:"
          grep -oP '<TargetFramework>[^<]+' "${{ env.PROJECT_FILE_PATH }}" || echo "No TargetFramework found"

      - name: Restore dependencies
        run: dotnet restore "${{ env.PROJECT_FILE_PATH }}"

      - name: Build project
        run: dotnet build "${{ env.PROJECT_FILE_PATH }}" --configuration Release --no-restore

      - name: Build and Pack
        run: |
          # Pack the project, but do not build again
          dotnet pack "${{ env.PROJECT_FILE_PATH }}" \
            --configuration Release \
            --no-build \
            --no-restore \
            --output ./nuget-packages \
            -p:Version=${{ env.PACKAGE_VERSION }} \
            -p:PackageVersion=${{ env.PACKAGE_VERSION }} \
            -p:IncludeSymbols=true \
            -p:SymbolPackageFormat=snupkg

      - name: List generated packages
        run: ls -la ./nuget-packages/

      - name: Publish to NuGet.org
        run: |
          # dotnet nuget push "./nuget-packages/${{ env.PACKAGE_NAME }}.${{ env.PACKAGE_VERSION }}.nupkg" \
          # Push both the main package and the symbols package
          dotnet nuget push "./nuget-packages/*.nupkg" \
            --api-key ${{ secrets.RA_UTILITIES_NUGET_KEY }} \
            --source "https://api.nuget.org/v3/index.json" \
            --skip-duplicate

      - name: Publish to GitHub Packages
        run: |
          dotnet nuget push "./nuget-packages/*.nupkg" \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
            --skip-duplicate

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ env.PACKAGE_NAME }} v${{ env.PACKAGE_VERSION }}
          body: |
            ## Version ${{ env.PACKAGE_VERSION }}

            This is a pre-release of the **${{ env.PACKAGE_NAME }}** package.

            - **View on NuGet.org:** [${{ env.PACKAGE_NAME }} ${{ env.PACKAGE_VERSION }}](https://www.nuget.org/packages/${{ env.PACKAGE_NAME }}/${{ env.PACKAGE_VERSION }})
          files: ./nuget-packages/*
          prerelease: true
